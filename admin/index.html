<html>
	<head>
		<script src="js/jquery-1.11.0.min.js"></script>
		<script src="js/purl.js"></script>
    	
    	<!-- bootstrap -->
    	<link rel="stylesheet" href="css/bootstrap.min.css" type="text/css">
    	<script src="js/bootstrap.min.js"></script>
		
    	<!-- node-webkit addons -->
		<script src="js/socket.io.min.js"></script>
	</head>
	<body>
		<div class="container" style="padding-top: 15px; padding-bottom: 15px;">
			<button class="btn btn-sm btn-default pull-right">Logout</button>
			<ul class="nav nav-tabs" role="tablist">
				<li class="active"><a href="#admin" role="tab" data-toggle="tab">Admin Panel</a></li>
				<li><a href="#mod" role="tab" data-toggle="tab">Mod Panel</a></li>
			</ul>
			<div class="tab-content well well-sm" style="border-top-left-radius: 0px; border-top-right-radius: 0px;">
					<div class="tab-pane fade in active" id="admin">
						<form class="form-inline">
							<input id="accessCode" type="text" class="form-control" placeholder="AccessCode"></input>
							<button id="changeCode" type="button" class="btn btn-sm btn-default">Change Code</button>
							<button id="newCode" type="button" class="btn btn-sm btn-default">New User Code</button>
						</form>
						<hr style="margin-top: 10px; margin-bottom: 10px;">
						<h4 style="margin-top: 0; display: inline;">Users</h4>
						&nbsp;
						<button id="usersRefresh" type="button" class="btn btn-sm btn-default" style="margin-bottom: 4px;">
							<span class="glyphicon glyphicon-refresh" style="top: 0px;">&#8203;</span>
						</button>
						<div class="well well-sm" style="margin-bottom: 0; padding-top: 0; background-color: white;">
							<table id="usersTable" class="table table-condensed table-hover" style="margin-bottom: 0;">
								<thead>
									<tr>
										<th>UserId</th>
										<th>Username</th>
										<th>Reg Date</th>
										<th>Access Code</th>
									</tr>
								</thead>
								<tbody id="usersTableBody" style="height: 100%; max-height: 0; overflow-y: auto;">
									<!-- Add users here -->
									<tr>
										<td>1</td>
										<td>username</td>
										<td>12-31-2014</td>
										<td>abcdefg</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
					<div class="tab-pane fade" id="mod">
						<form class="form-inline">
							<div class="form-group">
								<label for="groupSelect">Group:</label>
								<select id="groupSelect" class="form-control">
									<option value="select" disabled selected>Select Group...</option>
									<!-- Append groups here -->
								</select>
							</div>
							&nbsp;&nbsp;
							<div class="checkbox">
								<label>
									<input id="openCheck" type="checkbox"> Open Group
								</label>
							</div>
							<button id="openUpdate" type="button" class="btn btn-xs btn-default">&#8203;<span class="glyphicon glyphicon-export"></span></button>
						</form>
						<hr style="margin-top: 10px; margin-bottom: 10px;">
						<h4 style="margin-top: 0; display: inline;">Users</h4>
						&nbsp;
						<button id="groupRefresh" type="button" class="btn btn-sm btn-default" style="margin-bottom: 4px;">
							<span class="glyphicon glyphicon-refresh" style="top: 0px;">&#8203;</span>
						</button>
						<button id="groupAddUser" type="button" class="btn btn-sm btn-default" style="margin-bottom: 4px;">
							<span class="glyphicon glyphicon-plus" style="top: 0px;">&#8203;</span>
						</button>
						<div class="well well-sm" style="margin-bottom: 0; padding-top: 0; background-color: white;">
							<table id="groupTable" class="table table-condensed table-hover" style="margin-bottom: 0;">
								<thead>
									<tr>
										<th>Username</th>
										<th>Mod</th>
										<th>Post</th>
									</tr>
								</thead>
								<tbody id="groupTableBody" style="height: 100%; max-height: 0; overflow-y: auto;">
									<!-- Add users here -->
									<tr>
										<td>username</td>
										<td>---</td>
										<td>Yes</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
			</div>
		</div>
	</body>
	<script>
		$(document).ready(function() {
			var gui = require('nw.gui');
			var win = gui.Window.get();
			win.resizeTo(800, 600);
			resizeTable();
			
			var server = $.url($(location).attr('href')).param('loginServer');
			var user = $.url($(location).attr('href')).param('loginUser');
			var pass = $.url($(location).attr('href')).param('loginPass');
			win.title = 'pngr - ' + user + ' @ ' + server;

			// Socket event for connect, connect response, receive info
			var socket = io.connect(server);
			var sessionId = '';

			socket.on('connect', function() {
				console.log('Connect success');
				sessionId = socket.socket.sessionid;
				socket.emit('adminJoinServer', {id: sessionId, user: user, pass: pass});
			});

			socket.on('disconnect', function() {
				alert('Disconnected.');
				$(location).attr('href', 'login.html');
			});

			var groupAccess = new Array();

			socket.on('adminJoinServerResponse', function(data) {
				// if mod
				if(data.security == 1) {
					$.each(data.groups, function(i, item) {
						$('#groupSelect').append('<option value="'+item.groupid+'">'+item.groupname+'</option>');
						groupAccess[item.groupid] = item.open;
					});
				}

				// if admin
				if(data.security == 2) {
					$('#accessCode').val(data.serverCode);

					$.each(data.groups, function(i, item) {
						$('#groupSelect').append('<option value="'+item.groupid+'">'+item.groupname+'</option>');
						groupAccess[item.groupid] = item.open;
					});
				}
			});

			/****
			  Admin panel functions
			****/
			$('#changeCode').click(function() {
				// Send message to server with new access code
				socket.emit('adminChangeCode', {id: sessionId, code: $('#changeCode').val()});
			});

			$('#newCode').click(function() {
				// Request new code from server
				socket.emit('adminNewCode', {id: sessionId});
			});

			$('#usersRefresh').click(function() {
				// remove 'refresh...' text and call update to get server users
				socket.emit('adminGetServerUsers', {id: sessionId});
			});

			/****
			  Mod panel functions
			****/
			$('#groupSelect').change(function() {
				// remove 'select' option, change checkbox, refresh/reset groupUsers list
				$('#groupSelect option[value="select"]').hide();
				$('#openCheck').checked(groupAccess[$('#groupSelect').val()]);
				$('#groupTableBody').html('');
			});

			$('#openUpdate').click(function() {
				// Update group's open status based on checkbox
				socket.emit('adminSetGroupOpen', {id: sessionId, groupid: $('#groupSelect').val()});
			});

			$('#groupRefresh').click(function() {
				// remove 'refresh...' text and call update to get group users
				if($('#groupSelect').val() !== 'select') {
					socket.emit('adminGetGroupUsers', {id: sessionId, groupid: $('#groupSelect').val()});
				}
			});

			$('#groupAddUser').click(function() {
				// open window to add user

			});

			win.on('resize', function() {
				resizeTable();
			});

			function resizeTable() {
				var componentHeights = 264;
				console.log(win.height);
				$('#usersTableBody').css('max-height', win.height-componentHeights);
			};
		});
	</script>
</html>